# REGLAS INICIALES TODO CERRADO
iptables -A INPUT -i lo -j ACCEPT
iptables -P INPUT DROP
iptables -P OUTPUT ACCEPT
iptables -P FORWARD DROP
# Clamp MSS TCP rule to fix MTU problems
iptables -A FORWARD -p tcp -o bmx+ -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
# QMP Masquerade options
iptables -t nat -A POSTROUTING -s 172.16.0.0/12 ! -d 172.16.0.0/12 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.0.0/16 ! -d 192.168.0.0/16 -j MASQUERADE
iptables -A FORWARD -p tcp -o eth1 -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
iptables -t nat -A POSTROUTING -o eth1 ! -d 10.0.0.0/8 -j MASQUERADE
# Abrimos el puerto del servidor DNS
iptables -A INPUT -i eth0 -s 0/0 -p tcp --dport 53 -j ACCEPT
iptables -A INPUT -i eth0 -s 0/0 -p udp --dport 53 -j ACCEPT
#Saltarse la politica por defecto
# Exceptions to default policy
iptables -A INPUT -p tcp --dport 80 -j ACCEPT       
iptables -A INPUT -p tcp --dport 443 -j ACCEPT      
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 8000 -j ACCEPT
iptables -A INPUT -p tcp --dport 8888 -j ACCEPT
iptables -A INPUT -p tcp --dport 3129 -j ACCEPT
#Puertos Habilitados
iptables -A OUTPUT  -p tcp --dport 80 -j ACCEPT
iptables -A INPUT   -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT  -p tcp --dport 443 -j ACCEPT
iptables -A INPUT   -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT  -p tcp --dport 22 -j ACCEPT
iptables -A INPUT   -p tcp --sport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT  -p tcp --dport 8000 -j ACCEPT
iptables -A INPUT   -p tcp --sport 8000 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT  -p tcp --dport 8888 -j ACCEPT
iptables -A INPUT   -p tcp --sport 8888 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT  -p tcp --dport 3129 -j ACCEPT
iptables -A INPUT   -p tcp --sport 3129 -m state --state NEW,ESTABLISHED -j ACCEPT
#PROXY
#iptables -t nat -A PREROUTING -i br-lan -p tcp --dport 80 -j DNAT --to 10.40.2.254:8888
#iptables -t nat -A PREROUTING -i br-lan -p tcp --dport 443 -j DNAT --to 10.40.2.254:8888
#Limitador de Trafico
iptables -A INPUT -p tcp --dport 80 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
iptables -A INPUT -p tcp --dport 8888 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
iptables -A INPUT -p tcp --dport 3129 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
